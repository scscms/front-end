<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FileSystem</title>
    <style></style>
</head>
<body>
<button type="button" onclick="createFile()">创建文件</button>
<button type="button" onclick="readFile()">读取文件</button>
<button type="button" onclick="readAllFile()">读取所有文件</button>
<div id="file"></div>
<script>
    //读取所有文件
    function readAllFile() {
        new Promise(resolve => {
            fileSystemObj.fs.root.getDirectory('/',{},function(dirEntry){
                var dirReader = dirEntry.createReader();
                dirReader.readEntries(function(results){
                    resolve(results);
                },fileSystemObj.errorHandler);
            },function(e){
                resolve([]);
            })
        }).then(arr=>{
            let list = '<ol>'
            for(var i = arr.length;i--;){
                let file = arr[i];
                if(file.isFile){
                    list+=`<li>File:<a href="javascript:void(0)">${file.name}</a> fullPath:${file.fullPath}</li>`;
                }else{
                    list+=`<li>Folder:${arr[i].name} fullPath:${arr[i].fullPath}</li>`;
                }
            }
            document.querySelector('#file').innerHTML=arr.length===0?'暂无文件':list+'</ol>'
        })
    }
    //读取文件
    function readFile() {
        fileSystemObj.fs.root.getFile('log.txt', {}, function(fileEntry) {
            fileEntry.file(function(file) {
                const reader = new FileReader();
                reader.onloadend = function(e) {
                    console.log(this.result)
                };
                reader.readAsText(file);
            }, fileSystemObj.errorHandler);
        }, fileSystemObj.errorHandler);
    }
    //创建文件
    function createFile() {
        const content = prompt('文本内容')
        fileSystemObj.fs.root.getFile('log.txt', {create: true, exclusive: true}, function (fileEntry) {
            console.log(fileEntry);//留意它的几个属性
            // 生成FileWriter对象
            fileEntry.createWriter(function (fileWriter) {
                fileWriter.onwriteend = function (e) {
                    console.log('写入完成');
                };
                fileWriter.onerror = function (e) {
                    console.log('写入失败: ' + e.toString());
                };
                //可以创建ArrayBuffer、Blob等对象写入文件，但不建议使用BlobBuilder弃用方法
                fileWriter.write(new Blob([content], {type: "text/plain"}));
            }, fileSystemObj.errorHandler);
        }, fileSystemObj.errorHandler);
    }

    const File = window.requestFileSystem || window.webkitRequestFileSystem;
    const fileSystemObj = {
        fs: null,//文件系统对象
        size: 52428800,//申请50M临时空间 50*1024*1024
        errorHandler: function (e) {
            //处理各种错误
            switch (e.name) {
                case 'QuotaExceededError':
                    break;
                case 'NotFoundError':
                    break;
                case 'SecurityError':
                    break;
                case 'InvalidStateError':
                    break;
                case 'InvalidModificationError':
                    break;
                default:
            }
            console.error(e.name)
        },
        initialize: function () {
            //初始化PERSISTENT(永久) or TEMPORARY(临时)
            File(window.TEMPORARY, this.size, fs => {
                this.fs = fs;
                console.log('ok')
            })
        }
    };
    if (File) {
        navigator.webkitTemporaryStorage.queryUsageAndQuota(function (usage, quota) {
            //usage已经使用的空间，quota申请的总空间
            if (!quota) {
                //还没有申请过空间
                navigator.webkitTemporaryStorage.requestQuota(fileSystemObj.size, function (grantedBytes) {
                    fileSystemObj.initialize();
                }, fileSystemObj.errorHandler);
            } else {
                fileSystemObj.initialize();
            }
        });
    }
</script>
</body>
</html>
